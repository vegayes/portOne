<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Spring Boot 테스트</title>
    </head>
    <body>
        <h1>결제하기 </h1>

        
        
    	<button onclick="requestPay()">결제하기</button>


        
        
        <!-- 결제 모달창 --> 
        <script type="text/javascript" th:src="@{https://cdn.iamport.kr/js/iamport.payment-1.1.5.js}"></script>
		<script type="text/javascript" th:src="@{https://code.jquery.com/jquery-1.12.4.min.js}" ></script>		
	    
	    <script>
	        var IMP = window.IMP;
	        IMP.init("imp82107782");
	
	        function requestPay() {
	            IMP.request_pay({
	                    pg: "html5_inicis",		//KG이니시스 pg파라미터 값
	                    pay_method: "card",		//결제 방법
	                    merchant_uid: "1234578" + new Date().getTime(),//주문번호 전달 ★
	                    name: "당근 10kg",		//상품 명★ 주문명 : 결제 테스트
	                    amount: 100,			//금액 ★
	      				buyer_email: "gildong@gmail.com", // ★
	      				buyer_name: "홍길동", // ★
	      				buyer_tel: "010-4242-4242", // ★
	      				buyer_addr: "서울특별시 강남구 신사동", // ★
	      				buyer_postcode: "01181" // ★
	                },
	                function (rsp) {
	      				//rsp.imp_uid 값으로 결제 단건조회 API를 호출하여 결제결과를 판단함.
	                    if (rsp.success) {
							
							// jQuery로 HTTP 요청
					        jQuery.ajax({
					            url: "{서버의 결제 정보를 받는 가맹점 endpoint}", 
					            method: "POST",
					            headers: { "Content-Type": "application/json" },
					            data: {
					                imp_uid: rsp.imp_uid,            //결제 고유번호     
					                merchant_uid: rsp.merchant_uid   //주문번호
					            }
					        }).done(function (data) {
					          // 가맹점 서버 결제 API 성공시 로직
					        })
							
				         // 결제 성공 시 로직,
				            var msg = "결제가 완료되었습니다.";
				            msg += "고유ID : " + rsp.imp_uid;
					       	msg += "상점 거래 ID : " + rsp.merchant_uid;
					       	msg += "결제 금액 : " + rsp.amount;
					       	msg += "카드 승인번호 : " + rsp.apply_num;
					       
					        console.log("msg:" + msg);
					        pay_info(rsp);
					       
					       // data.impUid = rsp.imp_uid;
					       // data.merchant_uid = rsp.merchant_uid;
					       // paymentComplete(data);
					        alert("결제 성공");
					        
	                    } else {
	                        alert("결제에 실패하였습니다. 에러 내용: " + rsp.error_msg);
	                        location.href = "goods_pay_fail.do?error_msg=" + rsp.error_msg;
	                    }
	                }
	            );
	        }
	        
	        // 결제 정보 전달
			function pay_info(rsp){
			      var form = document.createElement('form');
			      var objs;
			 
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buyer_name');
			      objs.setAttribute('value', rsp.buyer_name);
			      form.appendChild(objs);
			 
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buyer_phone');
			      objs.setAttribute('value', rsp.buyer_tel);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'member_email');
			      objs.setAttribute('value', rsp.buyer_email);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buy_addr');
			      objs.setAttribute('value', rsp.buyer_addr);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buy_product_name');
			      objs.setAttribute('value', rsp.name);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buyer_buyid');
			      objs.setAttribute('value', rsp.imp_uid);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buyer_merid');
			      objs.setAttribute('value', rsp.merchant_uid);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'amount');
			      objs.setAttribute('value', rsp.paid_amount);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buyer_card_num');
			      objs.setAttribute('value', rsp.apply_num);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buyer_pay_ok');
			      objs.setAttribute('value', rsp.success);
			      form.appendChild(objs);
			      
			      objs = document.createElement('input');
			      objs.setAttribute('type', 'hidden');
			      objs.setAttribute('name', 'buyer_postcode');
			      objs.setAttribute('value', rsp.buyer_postcode);
			      form.appendChild(objs);
			 
			      form.setAttribute('method', 'post');
			      form.setAttribute('th:action', "@{/search}");
			      document.body.appendChild(form);
			      form.submit();
			}
		</script>
    

	
	
	
    </body>
</html>